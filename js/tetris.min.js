import Tetromino from"../js/tetromino.min.js";import Position from"../js/position.min.js";import{clearScores,addScore}from"../js/db.min.js";CanvasRenderingContext2D.prototype.roundRect=function(t,e,i,s,o){return i<2*o&&(o=Math.floor(i/2)),s<2*o&&(o=Math.floor(s/2)),this.beginPath(),this.moveTo(t+o,e),this.arcTo(t+i,e,t+i,e+s,o),this.arcTo(t+i,e+s,t,e+s,o),this.arcTo(t,e+s,t,e,o),this.arcTo(t,e,t+i,e,o),this.closePath(),this};export default class Tetris{static START_SPEED=1500;static instanceCounter=0;static MOBILE_HELP_TEXT="CONTROLS:\n  use screen buttons or swipes\n  - LEFT/RIGHT/DOWN swipe - left/right/down move\n  - UP swipe - rotation\n  - multitouch x3 - pause\n  - multitouch x4 - restart";static PC_HELP_TEXT="CONTROLS:\n  ⬅️ ➡️ ⬇️ or A, D, S - left/right/down move\n  ⬆️ or W - rotation\n  Q, E - counterclockwise and clockwise rotation\n  F1 - help\n  P - pause\n  Enter - restart\n  Space - hard drop\n";static LIST_OF_COLORS=["rgb(255,127,0)","rgb(0, 0, 255)","rgb(0, 255, 0)","rgb(203, 40, 40)","rgb(114,188,212)","rgb(237, 226, 21)","rgb(161, 13, 143)","gray"];static LIST_OF_DARKER_COLORS=["rgb(120,60,0)","rgb(0, 0, 120)","rgb(0, 120, 0)","rgb(100, 20, 20)","rgb(57,99,106)","rgb(115, 112, 10)","rgb(80, 6, 71)","gray"];static LIST_OF_TETROMINOES=["L","J","S","Z","I","O","T"];static LIST_OF_SCORES=[40,100,300,1200];static CELLS_COUNT=20;static PADDING=20;static DOWN=-2;static STEP_SPEED=75;static LEFT=-1;static RIGHT=1;static UP=2;static activeCounter=0;static AnimationTime=300;static BACKGROUND_AUDIO_LIST=[new Audio("./audio/background/1.mp3")];clearedLines=[];buttons=[];board=[];score=0;lvl=1;line=0;isTouchableDevice=!1;helpText=Tetris.PC_HELP_TEXT;isGameOver=!1;isPaused=!1;isActive=!1;currentTimerID=null;isAnimation=!1;botTimer=null;isBackgroundAudio=!1;isStoppedAudio=!0;fullScreenBtn=document.getElementById("fullscreen_button");leftBtn=document.getElementById("left_button");rightBtn=document.getElementById("right_button");helpBtn=document.getElementById("help_button");musicBtn=document.getElementById("music_button");musicLine=document.getElementById("music_line");themeBtn=document.getElementById("dark_light_theme_button");clockwiseBtn=document.getElementById("clockwise_button");counterClockwiseBtn=document.getElementById("counterclockwise_button");downBtn=document.getElementById("down_button");harddropBtn=document.getElementById("harddrop_button");nextLabel=document.getElementById("next_label");scoreLabel=document.getElementById("score_label");levelLabel=document.getElementById("level_label");linesLabel=document.getElementById("lines_label");glass=document.getElementById("glass");next=document.getElementById("next");body=document.getElementById("_body");isDisableSound=!0;constructor(t,e,i,s=!1){this.canvas=t,this.ctx=t.getContext("2d"),this.isOpponent=s,this.setSize(e,i),this.currentTetromino=this.createNewTetromino(),this.nextTetromino=this.createNewTetromino(),this.boardMatrix=this.createFieldMatrix(),this.setButtons(),this.setLabels(),this.createMatrixOfColors(),Tetris.instanceCounter++,this.currentSpeed=Tetris.START_SPEED,this.dpi=window.devicePixelRatio,Tetris.BACKGROUND_AUDIO_LIST[0].loop=!0}stopBackgroundAudio(){this.isStoppedAudio||(this.isStoppedAudio=!0,Tetris.BACKGROUND_AUDIO_LIST[0].pause())}resumeBackgroundAudio(){!this.isDisableSound&&this.isStoppedAudio&&Tetris.BACKGROUND_AUDIO_LIST[0].play().then((()=>{this.isStoppedAudio=!1})).catch((()=>{}))}start(){this.repaintTimer=setInterval(this.paint.bind(this),33),this.currentTimerID=setTimeout(this.restartTimer.bind(this),this.currentSpeed)}restart(){this.ctx.clearRect(0,0,this.width,this.height),this.stopTimer(),clearInterval(this.repaintTimer),this.score=0,this.lvl=1,this.line=0,this.clearedLines=[],this.currentSpeed=Tetris.START_SPEED,this.isGameOver=!1,this.isPaused=!1,this.currentTimerID=null,this.isAnimation=!1,this.currentTetromino=this.createNewTetromino(),this.nextTetromino=this.createNewTetromino(),this.boardMatrix=this.createFieldMatrix(),this.createMatrixOfColors(),this.start()}changePausedStatus(){this.isGameOver||(this.isPaused?this.isPaused=!1:this.isPaused=!0,this.changeTimerStatus())}stopTimer(){clearInterval(this.currentTimerID),this.currentTimerID=null}restartTimer(t=null){this.move(0,1),this.stopTimer(),this.isGameOver||(this.currentTimerID=setTimeout(this.restartTimer.bind(this),t?this.currentSpeed+t:this.currentSpeed))}changeTimerStatus(){this.currentTimerID?this.stopTimer():(clearInterval(this.currentTimerID),this.isGameOver||this.currentTetromino.move(0,-1),this.restartTimer())}changeActive(){this.isActive?(this.isActive=!1,Tetris.activeCounter--):(this.isActive=!0,Tetris.activeCounter++)}createMatrixOfColors(){this.matrixOfColors=[];for(let t=0;t<Tetris.CELLS_COUNT;t++)this.matrixOfColors.push(new Array(Math.floor(Tetris.CELLS_COUNT/2)).fill(-1))}createFieldMatrix(){let t=[];for(let e=0;e<Tetris.CELLS_COUNT+1;e++){let i=[2];for(let t=0;t<Math.floor(Tetris.CELLS_COUNT/2)+1;t++)e==Tetris.CELLS_COUNT||t==Math.floor(Tetris.CELLS_COUNT/2)?i.push(2):i.push(0);Tetris.PADDING,t.push(i)}return t}drawFieldDetails(){for(let t=0;t<this.boardMatrix.length-1;t++)for(let e=1;e<this.boardMatrix[0].length-1;e++)2==this.boardMatrix[t][e]&&(this.ctx.fillStyle=Tetris.LIST_OF_COLORS[this.matrixOfColors[t][e-1]],this.ctx.roundRect((e-1)*this.cellSize+this.glassPos.x,t*this.cellSize+this.glassPos.y,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).fill(),this.ctx.roundRect((e-1)*this.cellSize+this.glassPos.x,t*this.cellSize+this.glassPos.y,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).stroke())}isCollided(t){try{for(let e=0;e<t.tetromino.length;e++)for(let i=0;i<t.tetromino[0].length;i++)if(1==t.tetromino[e][i]){if(t.y<0)return!1;if(this.boardMatrix[t.y+e][t.x+i+1]+1>=3)return!0}}catch{return!1}return!1}createNewTetromino(){let value=this.getRandomInt(7),tetromino=eval(`new Tetromino(Tetromino.${Tetris.LIST_OF_TETROMINOES[value]}, 3, 0, Tetris.LIST_OF_COLORS[value], value)`);return tetromino}getRandomInt(t){return Math.floor(Math.random()*t)}move(t,e){if(this.checkGameOver(),this.isGameOver||this.isPaused||this.isAnimation)return!1;let i=this.currentTetromino.clone();if(this.currentTetromino.move(t,e),this.isCollided(this.currentTetromino)){if(this.currentTetromino=i,i=this.currentTetromino.clone(),this.currentTetromino.move(0,1),this.isCollided(this.currentTetromino)&&(this.currentTetromino=i),this.currentTetromino.y===i.y){this.changeTimerStatus();let t=this.currentTetromino.clone();this.currentTetromino=this.nextTetromino.clone(),this.changeTimerStatus(),this.nextTetromino=this.createNewTetromino(),this.checkGameOver();try{this.addToBoard(t)}catch{this.setGameOver()}return!1}this.currentTetromino.move(0,-1)}return!0}addToBoard(t){let e=t.colorID;for(let i=0;i<t.tetromino.length;i++)for(let s=0;s<t.tetromino[0].length;s++)1===t.tetromino[i][s]&&(this.boardMatrix[t.y+i][t.x+s+1]=2,this.matrixOfColors[t.y+i][t.x+s]=e);this.clearLines()}hardDrop(){if(!this.isGameOver)for(;;)if(!this.move(0,1))return}rotate(t){if(this.isGameOver||this.isPaused||this.isAnimation)return;let e=this.currentTetromino.clone();this.currentTetromino.rotate(t),this.isCollided(this.currentTetromino)&&(this.currentTetromino=e)}setSize(t,e){this.width=t,this.height=e;let i=Math.abs(t-e);this.cellSize=t>e?Math.floor((t-i-6*Tetris.PADDING)/Tetris.CELLS_COUNT):Math.floor((e-i-6*Tetris.PADDING)/Tetris.CELLS_COUNT),1==Tetris.activeCounter?this.glassPos=new Position(Math.floor(t/2)-9*this.cellSize,3*Tetris.PADDING):(this.cellSize=t>e?Math.floor(t/50):Math.floor(e/50),this.glassPos=this.isOpponent?new Position(2*Tetris.PADDING+Math.floor(t/2),6*Tetris.PADDING):new Position(5*this.cellSize,3*Tetris.PADDING)),this.glass.style.width=`${this.canvasCords2Document(Tetris.CELLS_COUNT/2*this.cellSize)}px`,this.glass.style.height=`${this.canvasCords2Document(Tetris.CELLS_COUNT*this.cellSize)}px`,this.glass.style.left=`${this.canvasCords2Document(this.glassPos.x)}px`,this.glass.style.top=`${this.canvasCords2Document(this.glassPos.y)}px`,this.glass.style.borderRadius=`${this.canvasCords2Document(this.cellSize/4)}px`,this.borderWidth=Math.floor(this.cellSize/7),this.fontSize=this.cellSize,this.body.style.fontSize=`${this.canvasCords2Document(this.fontSize)}px`,this.ctx.font=`${this.fontSize}px Minecrafter Alt`,this.next.style.width=`${this.canvasCords2Document(this.cellSize*Math.floor(Tetris.CELLS_COUNT/3))}px`,this.next.style.height=`${this.canvasCords2Document(this.cellSize*Math.floor(Tetris.CELLS_COUNT/3))}px`,this.next.style.left=`${this.canvasCords2Document(this.glassPos.x+11*this.cellSize)}px`,this.next.style.top=`${this.canvasCords2Document(this.cellSize+this.glassPos.y)}px`,this.next.style.borderRadius=`${this.canvasCords2Document(this.cellSize/4)}px`}canvasCords2Document(t,e=null){let i=this.canvas.getBoundingClientRect(),s=t*(i.right-i.left)/this.width;return e?{x:s,y:e/this.height*(i.bottom-i.top)}:s}paint(){if(this.isActive&&(this.ctx.textAlign="center",this.checkGameOver(),this.update(),this.ctx.lineWidth=this.borderWidth,this.drawNextAndLabels(),this.drawFieldDetails(),!this.isAnimation)){if(this.drawCurrentTetromino(),this.drawShadow(),this.isGameOver)return this.drawTextOnGlass("game over"),void this.stopTimer();this.isPaused&&this.drawTextOnGlass("paused")}}drawTextOnGlass(t){let e=new Position(Math.floor(this.glassPos.x+Tetris.CELLS_COUNT*this.cellSize/4),Math.floor(this.glassPos.y+Tetris.CELLS_COUNT*this.cellSize/2));this.ctx.fillStyle="red",this.ctx.fillText(t,e.x,e.y)}checkGameOver(){if(this.isGameOver)return!0;for(let t=1;t<this.boardMatrix[0].length-1;t++)2==this.boardMatrix[0][t]&&this.setGameOver()}setGameOver(){this.isGameOver||(addScore(this.score,this.lvl,this.line),this.isGameOver=!0)}copyMatrix(t){let e=[];for(let i=0;i<t.length;i++)e.push(Array.from(t[i]));return e}clearLines(){if(this.isAnimation)return;let t=this.copyMatrix(this.boardMatrix),e=this.copyMatrix(this.matrixOfColors),i=0,s=!0;for(let o=0;o<this.boardMatrix.length-1;o++){s=!0;for(let t=1;t<this.boardMatrix[0].length-1;t++)if(2!=this.boardMatrix[o][t]){s=!1;break}if(s){this.clearedLines.push(o),t[o]=Array.from(t[0]);for(let i=o;i>0;i--)t[i]=Array.from(t[i-1]),e[i]=Array.from(e[i-1]);t[0]=new Array(Math.floor(Tetris.CELLS_COUNT/2)+2).fill(0),t[0][0]=2,t[0][Math.floor(Tetris.CELLS_COUNT/2)+1]=2,e[0]=new Array(Math.floor(Tetris.CELLS_COUNT/2)).fill(-1),i++}}let o=this.lvl;i&&(this.score+=Tetris.LIST_OF_SCORES[i-1]*this.lvl,this.line+=i,this.lvl=Math.floor(this.line/10)+1,this.lvl>o&&(this.currentSpeed-=this.currentSpeed>Tetris.STEP_SPEED?Tetris.STEP_SPEED:0),this.animation(t,e))}animation(t,e){this.isAnimation=!0,this.changeTimerStatus();let i=setInterval((()=>{for(let t=0;t<this.clearedLines.length;t++)for(let e=0;e<this.matrixOfColors[t].length;e++)this.matrixOfColors[this.clearedLines[t]][e]=this.getRandomInt(7)}));setTimeout((()=>{this.ctx.strokeStyle="black",this.isAnimation=!1,this.clearedLines=[],clearInterval(i),this.matrixOfColors=e,this.boardMatrix=t,this.currentTetromino.move(0,-1),this.restartTimer(Tetris.AnimationTime)}),Tetris.AnimationTime)}setButtons(){let t=Math.floor((this.height-2*Tetris.PADDING)/4),e=Math.floor(this.height/2),i=Tetris.PADDING,s=5*this.cellSize,o=s;this.width<this.height&&(t=Math.floor((this.width-2*Tetris.PADDING)/4),e=this.height-(this.height-(this.glassPos.y+Tetris.CELLS_COUNT*this.cellSize))/2-o),this.leftBtn.style.width=`${this.canvasCords2Document(s)}px`,this.leftBtn.style.height=`${this.canvasCords2Document(o)}px`,this.leftBtn.style.left=`${this.canvasCords2Document(i)}px`,this.leftBtn.style.top=`${this.canvasCords2Document(e)}px`,this.rightBtn.style.width=`${this.canvasCords2Document(s)}px`,this.rightBtn.style.height=`${this.canvasCords2Document(o)}px`,this.rightBtn.style.left=`${this.canvasCords2Document(i+t)}px`,this.rightBtn.style.top=`${this.canvasCords2Document(e)}px`,this.clockwiseBtn.style.width=`${this.canvasCords2Document(s)}px`,this.clockwiseBtn.style.height=`${this.canvasCords2Document(o)}px`,this.clockwiseBtn.style.left=`${this.canvasCords2Document(this.width-i-s)}px`,this.clockwiseBtn.style.top=`${this.canvasCords2Document(e)}px`,this.counterClockwiseBtn.style.width=`${this.canvasCords2Document(s)}px`,this.counterClockwiseBtn.style.height=`${this.canvasCords2Document(o)}px`,this.counterClockwiseBtn.style.left=`${this.canvasCords2Document(this.width-i-t-s)}px`,this.counterClockwiseBtn.style.top=`${this.canvasCords2Document(e)}px`,this.downBtn.style.width=`${this.canvasCords2Document(s)}px`,this.downBtn.style.height=`${this.canvasCords2Document(o)}px`,this.downBtn.style.left=`${this.canvasCords2Document(i+Math.floor(t/2))}px`,this.downBtn.style.top=`${this.canvasCords2Document(e+Math.floor(t*Math.sqrt(3)/2))}px`,this.harddropBtn.style.width=`${this.canvasCords2Document(s)}px`,this.harddropBtn.style.height=`${this.canvasCords2Document(o)}px`,this.harddropBtn.style.left=`${this.canvasCords2Document(this.width-i-t/2-s)}px`,this.harddropBtn.style.top=`${this.canvasCords2Document(e+Math.floor(t*Math.sqrt(3)/2))}px`,s=this.canvasCords2Document(2*this.cellSize),this.fullScreenBtn.style.width=`${s}px`,this.fullScreenBtn.style.height=`${s}px`,this.musicBtn.style.height=.9*s+"px",this.musicBtn.style.width=.9*s+"px",this.musicLine.style.height=.9*s+"px",this.musicLine.style.width=.8*s+"px",this.helpBtn.style.height=`${s}px`,this.helpBtn.style.width=`${s}px`,this.themeBtn.style.width=`${s}px`,this.themeBtn.style.height=`${s}px`,e=this.glassPos.y-s,i=this.glassPos.x+11*this.cellSize+this.cellSize*Math.floor(Tetris.CELLS_COUNT/3)+this.cellSize/2;let h=this.canvasCords2Document(i,e+.25*s);this.fullScreenBtn.style.left=`${h.x}px`,this.fullScreenBtn.style.top=`${h.y}px`,h=this.canvasCords2Document(i,e+2*this.cellSize),this.helpBtn.style.left=`${h.x}px`,this.helpBtn.style.top=`${h.y}px`,h=this.canvasCords2Document(i,e+.25*s+4*this.cellSize),this.musicBtn.style.left=`${h.x}px`,this.musicBtn.style.top=`${h.y}px`,this.musicLine.style.left=`${h.x}px`,this.musicLine.style.top=`${h.y}px`,h=this.canvasCords2Document(i,e+.25*s+6*this.cellSize),this.themeBtn.style.left=`${h.x}px`,this.themeBtn.style.top=`${h.y}px`}setLabels(){let t=this.cellSize+this.glassPos.y-this.fontSize,e=this.cellSize*Math.floor(Tetris.CELLS_COUNT/3),i=this.glassPos.x+11*this.cellSize;Math.floor(this.cellSize*Math.floor(Tetris.CELLS_COUNT/3)/2);let s=6*this.cellSize,o=this.canvasCords2Document(this.fontSize);s=this.canvasCords2Document(s),i=this.canvasCords2Document(i),e=this.canvasCords2Document(e)+o/10,t=this.canvasCords2Document(t),this.nextLabel.style.left=`${i}px`,this.nextLabel.style.top=t-o+"px",this.nextLabel.style.width=`${s}px`,this.scoreLabel.style.left=`${i}px`,this.scoreLabel.style.top=`${t+e}px`,this.scoreLabel.style.width=`${s}px`,this.linesLabel.style.left=`${i}px`,this.linesLabel.style.top=`${t+1.5*e}px`,this.linesLabel.style.width=`${s}px`,this.levelLabel.style.left=`${i}px`,this.levelLabel.style.top=`${t+2*e}px`,this.levelLabel.style.width=`${s}px`}coords2Canvas(t,e){let i=this.canvas.getBoundingClientRect();return x_pos=(t-i.left)/(i.right-i.left)*this.width,y_pos=(e-i.top)/(i.bottom-i.top)*this.height,{x_pos:x_pos,y_pos:y_pos}}drawNextAndLabels(){if(this.isTouchableDevice&&this.isOpponent)return;let t=this.glassPos.x+11*this.cellSize,e=this.cellSize+this.glassPos.y,i=this.cellSize*Math.floor(Tetris.CELLS_COUNT/3),s=this.cellSize*Math.floor(Tetris.CELLS_COUNT/3),o=t+Math.floor(i/2),h=e+Math.floor(s/2);this.drawLabels(o,e,s),this.ctx.fillStyle=this.nextTetromino.color;for(let t=0;t<this.nextTetromino.tetromino.length;t++)for(let e=0;e<this.nextTetromino.tetromino[0].length;e++)if(this.nextTetromino.tetromino[t][e]){let i=(e-this.nextTetromino.tetromino[0].length/2)*this.cellSize+o,s=(t-this.nextTetromino.tetromino.length/2)*this.cellSize+h;this.ctx.roundRect(i,s,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).fill(),this.ctx.roundRect(i,s,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).stroke()}}drawLabels(t,e,i){this.ctx.fillStyle="red",this.ctx.fillText(`${this.score}`,t,e+i+2*this.cellSize),this.ctx.fillText(`${this.line}`,t,e+i+5*this.cellSize),this.ctx.fillText(`${this.lvl}`,t,e+i+8*this.cellSize)}drawCurrentTetromino(){this.ctx.fillStyle=this.currentTetromino.color;for(let t=0;t<this.currentTetromino.tetromino.length;t++)for(let e=0;e<this.currentTetromino.tetromino[0].length;e++)if(this.currentTetromino.tetromino[t][e]){let i=(this.currentTetromino.x+e)*this.cellSize+this.glassPos.x,s=(this.currentTetromino.y+t)*this.cellSize+this.glassPos.y;this.ctx.roundRect(i,s,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).fill(),this.ctx.roundRect(i,s,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).stroke()}}drawShadow(){this.ctx.globalAlpha=.2,this.ctx.fillStyle=Tetris.LIST_OF_COLORS[this.currentTetromino.colorID];let t=this.currentTetromino.clone(),e=!1,i=null;for(;i=t.clone(),t.move(0,1),e=this.isCollided(t),!e;);if(e){if(t=i,i=t.clone(),t.move(0,1),this.isCollided(t)&&(t=i),t.y===i.y)for(let e=0;e<t.tetromino.length;e++)for(let i=0;i<t.tetromino[0].length;i++)1==t.tetromino[e][i]&&this.ctx.roundRect((t.x+i)*this.cellSize+this.glassPos.x,(t.y+e)*this.cellSize+this.glassPos.y,this.cellSize,this.cellSize,Math.floor(this.cellSize/4)).fill();t.move(0,-1)}this.ctx.globalAlpha=1}drawGlass(){this.ctx.fillStyle="black",this.isTouchableDevice&&this.isOpponent?this.ctx.fillRect(this.glassPos.x,this.glassPos.y,this.cellSize*Math.floor(Tetris.CELLS_COUNT/2),this.cellSize*Tetris.CELLS_COUNT):this.ctx.roundRect(this.glassPos.x,this.glassPos.y,this.cellSize*Math.floor(Tetris.CELLS_COUNT/2),this.cellSize*Tetris.CELLS_COUNT,this.cellSize).fill()}drawHelp(){let t=this.glassPos.x+11*this.cellSize+this.cellSize*Math.floor(Tetris.CELLS_COUNT/3);this.ctx.drawImage(Tetris.helpImg,t,this.glassPos.y,2*this.cellSize,2*this.cellSize)}update(){1!==Tetris.activeCounter||this.isOpponent?this.isTouchableDevice?this.ctx.clearRect(0,0,this.width,this.glassPos.y+this.cellSize):this.isOpponent?this.ctx.clearRect(Math.floor(this.width/2),0,this.width,this.height):this.ctx.clearRect(0,0,Math.floor(this.width/2),this.height):this.ctx.clearRect(0,0,this.width,this.height)}getRandomInt(t){return Math.floor(Math.random()*t)}}
