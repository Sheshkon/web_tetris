import Tetris from"../js/tetris.min.js";import Tetromino from"../js/tetromino.min.js";const delayTime=85;let tetris=null,keyDownTimerID=[[],[],[]],buttonDownTimerID=[[],[],[]],isFired=[!1,!1,!1],xDown=null,yDown=null,isLightTheme=!1;const body=document.getElementById("_body"),backs=document.getElementById("backs"),control=document.getElementById("control"),canvas=document.getElementById("game_field"),helpModal=document.querySelector("#help_modal"),settingsModal=document.querySelector("#settings_modal"),highscoreModal=document.querySelector("#highscore_modal"),helpPCText=document.getElementById("pc_help_text"),helpMobileText=document.getElementById("mobile_help_text");function cache(){localStorage.setItem("tetris",JSON.stringify(tetris)),localStorage.setItem("currentTetromino",JSON.stringify(tetris.currentTetromino)),localStorage.setItem("nextTetromino",JSON.stringify(tetris.nextTetromino))}let leftMoveTimerID,rightMoveTimerID,downMoveTimerID,hardDropTimerId,rotateCounterWiseTimerId,clockWiseTimerID;function switchTheme(){isLightTheme?setDarkTheme():setLightTheme(),localStorage.setItem("isLightTheme",isLightTheme)}function setDarkTheme(){$("#bg").addClass("darkTheme"),$("#labels").addClass("darkTheme"),$("#settings").addClass("darkTheme"),$("#settings_modal").addClass("darkTheme"),isLightTheme=!1}function setLightTheme(){$("#bg").removeClass("darkTheme"),$("#labels").removeClass("darkTheme"),$("#settings").removeClass("darkTheme"),$("#settings_modal").removeClass("darkTheme"),isLightTheme=!0}function mouseOverMusicLine(){tetris.isTouchableDevice||$("#music_line").css("transform","scale(1.3,1.3)")}function mouseOutMusicLine(){tetris.isTouchableDevice||$("#music_line").css("transform","scale(1,1)")}function pauseResumeMusic(){tetris.changePausedStatus(),highscoreModal.showModal()}function fullScreen(){canvas.requestFullscreen?body.requestFullscreen():canvas.webkitRequestFullscreen?body.webkitRequestFullscreen():canvas.msRequestFullscreen&&body.msRequestFullscreen()}function checkMoves(){isFired[0]&&tetris.move(0,1),isFired[1]&&tetris.move(-1,0),isFired[2]&&tetris.move(1,0)}function start(){let e=!1;tetris=new Tetris(canvas,canvas.width,canvas.height),e=window.mobileCheck(),e?(tetris.isTouchableDevice=!0,tetris.helpText=Tetris.MOBILE_HELP_TEXT,control.style.visibility="visible",helpMobileText.style.display="inline"):helpPCText.style.display="inline",tetris.changeActive(),setSize(),tetris.start(),setInterval(checkMoves,75),loadCashes(),document.getElementById("buttons").style.visibility="visible",document.getElementById("labels").style.visibility="visible",backs.style.visibility="visible"}function loadCashes(){JSON.parse(localStorage.getItem("isLightTheme"))&&setLightTheme();let e=JSON.parse(localStorage.getItem("tetris"));if(!e)return;tetris.score=e.score,tetris.line=e.line,tetris.lvl=e.lvl,tetris.boardMatrix=e.boardMatrix,tetris.matrixOfColors=e.matrixOfColors,tetris.currentSpeed=e.currentSpeed;let t=JSON.parse(localStorage.getItem("currentTetromino")),o=JSON.parse(localStorage.getItem("nextTetromino"));t&&(tetris.currentTetromino=new Tetromino(tetris.currentTetromino.tetromino=t.tetromino,tetris.currentTetromino.x=t.x,tetris.currentTetromino.y=t.y,tetris.currentTetromino.color=t.color,tetris.currentTetromino.colorID=t.colorID)),o&&(tetris.nextTetromino=new Tetromino(tetris.nextTetromino.tetromino=o.tetromino,tetris.nextTetromino.x=o.x,tetris.nextTetromino.y=o.y,tetris.nextTetromino.color=o.color,tetris.nextTetromino.colorID=o.colorID))}function setSize(){canvas.width=window.innerWidth,canvas.height=window.innerHeight;const e=Math.ceil(window.devicePixelRatio);canvas.width=window.innerWidth*e,canvas.height=window.innerHeight*e,canvas.style.width=`${window.innerWidth}px`,canvas.style.height=`${window.innerHeight}px`,tetris.setSize(canvas.width,canvas.height),tetris.setButtons(),tetris.setLabels()}function showHelp(){tetris.changePausedStatus(),setTimeout((()=>{helpModal.showModal()}),85)}function closeHelpModel(){helpModal.close(),tetris.changePausedStatus()}function closeHighscoreModal(){highscoreModal.close(),tetris.changePausedStatus()}function handleKeyDown(e){let t=e.key;if(e.preventDefault(),helpModal.open)return void("Enter"==t&&closeHelpModel());if(highscoreModal.open)return void("Enter"==t&&closeHighscoreModal());let o=e.code;"DOWN"!=t&&"ArrowDown"!=t&&"KeyS"!=o||(isFired[0]=!0),"Up"!=t&&"ArrowUp"!=t&&"KeyW"!=o&&"KeyE"!=o||tetris.rotate(!0),"KeyQ"==o&&tetris.rotate(!1),"Left"!=t&&"ArrowLeft"!=t&&"KeyA"!=o||(isFired[1]=!0),"Right"!=t&&"ArrowRight"!=t&&"KeyD"!=o||(isFired[2]=!0),"Enter"==t&&(tetris.restart(),setSize()),"p"!=t&&"KeyP"!=o||tetris.changePausedStatus(),"F1"!=t&&"F1"!=o||showHelp(),"Space"===e.code&&tetris.hardDrop(),"F11"===e.code&&fullScreen()}function handleKeyUP(e){let t=e.key,o=e.code;"Right"!=t&&"ArrowRight"!=t&&"KeyD"!=o||(isFired[2]=!1),"Left"!=t&&"ArrowLeft"!=t&&"KeyA"!=o||(isFired[1]=!1),"DOWN"!=t&&"ArrowDown"!=t&&"KeyS"!=o||(isFired[0]=!1)}function getTouches(e){return e.touches||e.originalEvent.touches}function handleTouchStart(e){const t=getTouches(e)[0];3==e.touches.length&&tetris.changePausedStatus(),4==e.touches.length&&tetris.restart(),xDown=t.clientX,yDown=t.clientY,tetris.isAnimation||e.preventDefault()}function clearButtonsIntervals(e,t=!1){if(t)for(let t=0;t<e.length;t++)clearInterval(e[t]);else for(let t=0;t<e.length;t++)clearInterval(e[t].timerID)}function handleTouchMove(e){if(xDown&&yDown){var t=e.touches[0].clientX,o=e.touches[0].clientY,i=xDown-t,r=yDown-o;Math.abs(i)>Math.abs(r)?i>0?tetris.move(-1,0):tetris.move(1,0):r>0?tetris.rotate(!0):tetris.move(0,1),xDown=null,yDown=null}}"serviceWorker"in navigator&&navigator.serviceWorker.register("/web_tetris/appCache.js").then((function(){})),window.addEventListener("beforeunload",(e=>{e.preventDefault(),cache(),e.returnValue=""})),window.mobileCheck=()=>{let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e},document.getElementById("help_button").addEventListener("click",showHelp,!1),document.getElementById("fullscreen_button").addEventListener("click",fullScreen),document.getElementById("music_button").addEventListener("click",pauseResumeMusic),document.getElementById("music_button").addEventListener("mouseover",mouseOverMusicLine),document.getElementById("music_button").addEventListener("mouseout",mouseOutMusicLine),document.getElementById("dark_light_theme_button").addEventListener("click",switchTheme,!1),document.addEventListener("keydown",handleKeyDown,!0),document.addEventListener("keyup",handleKeyUP,!1),document.addEventListener("touchstart",handleTouchStart,!1),document.getElementById("close_help_modal").addEventListener("click",closeHelpModel,!1),document.getElementById("close_highscore_modal").addEventListener("click",closeHighscoreModal,!1),$("#left_button").on("touchstart",(function(e){e.preventDefault(),tetris.move(-1,0),$(this).addClass("pushed"),$(this).removeClass("border"),leftMoveTimerID=setInterval((()=>{tetris.move(-1,0)}),85),buttonDownTimerID[0].push(leftMoveTimerID)})).bind("touchend",(()=>{buttonDownTimerID[0].forEach((e=>{clearInterval(e)})),buttonDownTimerID[0]=[],$("#left_button").removeClass("pushed"),$("#left_button").addClass("border")})),$("#right_button").on("touchstart",(function(e){e.preventDefault(),tetris.move(1,0),$(this).addClass("pushed"),$(this).removeClass("border"),rightMoveTimerID=setInterval((()=>{tetris.move(1,0)}),85),buttonDownTimerID[1].push(rightMoveTimerID)})).bind("touchend",(()=>{buttonDownTimerID[1].forEach((e=>{clearInterval(e)})),buttonDownTimerID[1]=[],$("#right_button").removeClass("pushed"),$("#right_button").addClass("border")})),$("#down_button").on("touchstart",(function(e){e.preventDefault(),tetris.move(0,1),$(this).addClass("pushed"),$(this).removeClass("border"),downMoveTimerID=setInterval((()=>{tetris.move(0,1)}),85),buttonDownTimerID[2].push(downMoveTimerID)})).bind("touchend",(()=>{buttonDownTimerID[2].forEach((e=>{clearInterval(e)})),buttonDownTimerID[2]=[],$("#down_button").removeClass("pushed"),$("#down_button").addClass("border")})),$("#harddrop_button").on("touchstart",(function(e){e.preventDefault(),tetris.hardDrop(),$(this).addClass("pushed"),$(this).removeClass("border"),hardDropTimerId&&clearTimeout(hardDropTimerId),hardDropTimerId=setTimeout((()=>{$("#harddrop_button").removeClass("pushed"),$("#harddrop_button").addClass("border"),hardDropTimerId=null}),85)})),$("#counterclockwise_button").on("touchstart",(function(e){e.preventDefault(),tetris.rotate(!1),$(this).addClass("pushed"),$(this).removeClass("border"),rotateCounterWiseTimerId&&clearTimeout(rotateCounterWiseTimerId),setTimeout((()=>{$("#counterclockwise_button").removeClass("pushed"),$("#counterclockwise_button").addClass("border"),rotateCounterWiseTimerId=null}),85)})),$("#clockwise_button").on("touchstart",(function(e){e.preventDefault(),tetris.rotate(!0),$(this).addClass("pushed"),$(this).removeClass("border"),clockWiseTimerID&&clearTimeout(clockWiseTimerID),setTimeout((()=>{$("#clockwise_button").removeClass("pushed"),$("#clockwise_button").addClass("border"),clockWiseTimerID=null}),85)})),canvas.onselectstart=()=>!1,window.addEventListener("load",(()=>{start()})),window.addEventListener("resize",(e=>{setSize(),buttonDownTimerID.forEach((e=>{e.forEach((e=>{clearInterval(e)}))})),buttonDownTimerID=[[],[],[]]}),!0),window.onfocus=()=>{tetris.resumeBackgroundAudio(),tetris.changePausedStatus()},window.onblur=()=>{tetris.stopBackgroundAudio(),tetris.changePausedStatus(),cache()};